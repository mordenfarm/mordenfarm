<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | AlfaOctal Campus Content Management</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK Integration -->
    <script>
        // IMPORTANT: Replace these with your actual Firebase project credentials.
        const firebaseConfig = {
  apiKey: "AIzaSyAru65x_Fgt8EY1inQ2irGaEjTCc23mFGM",
  authDomain: "mordern-farm.firebaseapp.com",
  databaseURL: "https://mordern-farm-default-rtdb.firebaseio.com",
  projectId: "mordern-farm",
  storageBucket: "mordern-farm.firebasestorage.app",
  messagingSenderId: "43708737487",
  appId: "1:43708737487:web:9409206d743d2c625454ba",
  measurementId: "G-P5LSG9GCFS"
};
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        try {
            const app = initializeApp(firebaseConfig);
            window.firebase = {
                app,
                auth: getAuth(app),
                db: getFirestore(app),
                storage: getStorage(app),
                // Auth functions
                onAuthStateChanged,
                signInWithEmailAndPassword,
                signOut,
                // Firestore functions
                doc,
                getDoc,
                setDoc,
                // Storage functions
                ref,
                uploadBytes,
                getDownloadURL,
                deleteObject
            };
            console.log("Firebase Initialized for Admin Panel.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    </script>

    <style>
        :root {
            --color-primary: #e53935;
            --color-success: #43a047;
            --bg-dark: #121212;
            --bg-light: #1e1e1e;
            --bg-card: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --border-color: #424242;
            --border-radius: 8px;
            --font-primary: 'Inter', sans-serif;
            --transition: all 0.3s ease;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-primary);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-size: 16px;
        }
        .container { width: 90%; max-width: 1200px; margin: 2rem auto; }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #login-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
        }
        #login-container h1 { margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-input {
            width: 100%; padding: 0.8rem; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-primary); font-size: 1rem;
        }
        .form-input:focus { border-color: var(--color-primary); outline: none; }
        .btn {
            width: 100%; padding: 0.8rem; border: none; border-radius: 4px;
            font-weight: 600; font-size: 1rem; cursor: pointer; transition: var(--transition);
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #c62828; }
        .error-text { color: var(--color-primary); margin-top: 1rem; font-weight: 500; }

        /* --- Admin Panel --- */
        #admin-panel { display: none; } /* Hidden by default */
        .admin-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color);
        }
        .admin-header h1 { font-size: 1.8rem; }
        .btn-logout {
            background: none; border: 1px solid var(--border-color); color: var(--text-secondary);
            padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600;
        }
        .btn-logout:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .content-section {
            background: var(--bg-card); padding: 1.5rem;
            border-radius: var(--border-radius); margin-bottom: 2rem;
        }
        .content-section h2 { margin-bottom: 1.5rem; font-size: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        textarea.form-input { min-height: 150px; resize: vertical; }

        /* Item lists (for modules, notes, videos) */
        .item-list { list-style: none; margin-top: 1.5rem; }
        .item-card {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-light); padding: 1rem; border-radius: 4px;
            margin-bottom: 0.5rem; border: 1px solid var(--border-color);
        }
        .item-info { flex-grow: 1; }
        .item-info strong { display: block; color: var(--text-primary); }
        .item-info span { font-size: 0.9rem; color: var(--text-secondary); }
        .btn-delete {
            background: #424242; color: var(--text-primary); padding: 0.5rem 0.8rem;
            border: none; border-radius: 4px; font-weight: 600; cursor: pointer;
        }
        .btn-delete:hover { background: var(--color-primary); }

        /* Master Save Button */
        #save-status {
            position: fixed; bottom: 20px; right: 20px; z-index: 50;
            padding: 1rem 1.5rem; border-radius: var(--border-radius);
            font-weight: 600; color: white; transition: var(--transition);
            transform: translateY(200%); opacity: 0;
        }
        #save-status.saving { background-color: #ffc107; color: black; transform: translateY(0); opacity: 1; }
        #save-status.success { background-color: var(--color-success); transform: translateY(0); opacity: 1; }
        #save-status.error { background-color: var(--color-primary); transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div id="login-container">
            <h1>Admin Login</h1>
            <form id="login-form">
                <div class="form-group">
                    <input type="email" id="login-email" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="login-error" class="error-text" style="display: none;"></p>
            </form>
        </div>
    </div>

    <!-- Main Admin Content -->
    <main id="admin-panel" class="container">
        <header class="admin-header">
            <h1>Edit: Broiler Rearing Course</h1>
            <div>
                 <button id="save-all-changes" class="btn btn-primary" style="width: auto; padding: 0.8rem 1.5rem;">Save All Changes</button>
                 <button id="logout-button" class="btn-logout" style="margin-left: 1rem;">Logout</button>
            </div>
        </header>

        <!-- Section 1: General Information -->
        <section class="content-section">
            <h2>General Information</h2>
            <div class="form-group">
                <label for="course-title" class="form-label">Course Title</label>
                <input type="text" id="course-title" class="form-input" placeholder="e.g., Ultimate Broiler Rearing Masterclass">
            </div>
            <div class="form-group">
                <label for="course-subtitle" class="form-label">Course Subtitle</label>
                <input type="text" id="course-subtitle" class="form-input" placeholder="e.g., From Chick to Profit in 7 Weeks">
            </div>
            <div class="form-group">
                <label for="course-description" class="form-label">Course Description</label>
                <textarea id="course-description" class="form-input" placeholder="Detailed description of the course. You can use <br> for line breaks."></textarea>
            </div>
        </section>

        <!-- Section 2: Course Modules -->
        <section class="content-section">
            <h2>Course Modules</h2>
            <form id="add-module-form">
                <div class="form-group">
                    <input type="text" id="module-title" class="form-input" placeholder="Module Title" required>
                </div>
                <div class="form-group">
                    <input type="text" id="module-description" class="form-input" placeholder="Module Description" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: auto;">+ Add Module</button>
            </form>
            <ul id="modules-list" class="item-list">
                <!-- Modules will be dynamically listed here -->
            </ul>
        </section>

        <!-- Section 3: Downloadable Notes (PDFs) -->
        <section class="content-section">
            <h2>Downloadable Notes (PDFs)</h2>
            <form id="add-note-form">
                <div class="form-group">
                    <input type="text" id="note-title" class="form-input" placeholder="Note Title (e.g., Week 1 Feeding Chart)" required>
                </div>
                <div class="form-group">
                     <label for="note-file" class="form-label">PDF File</label>
                    <input type="file" id="note-file" class="form-input" accept=".pdf" required>
                </div>
                <button type="submit" id="add-note-btn" class="btn btn-primary" style="width: auto;">+ Upload & Add Note</button>
            </form>
            <ul id="notes-list" class="item-list">
                <!-- Notes will be dynamically listed here -->
            </ul>
        </section>

        <!-- Section 4: Video Gallery -->
        <section class="content-section">
            <h2>Video Gallery</h2>
            <form id="add-video-form">
                <div class="form-group">
                    <input type="text" id="video-title" class="form-input" placeholder="Video Title" required>
                </div>
                <div class="form-group">
                    <input type="url" id="video-url" class="form-input" placeholder="Full YouTube URL (e.g., https://www.youtube.com/watch?v=...)" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: auto;">+ Add Video</button>
            </form>
             <ul id="videos-list" class="item-list">
                <!-- Videos will be dynamically listed here -->
            </ul>
        </section>
    </main>
    
    <div id="save-status"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // IMPORTANT: Add the email addresses of authorized admins here.
            const ADMIN_EMAILS = ["admin@alfaoctal.com", "admin2@alfaoctal.com"];
            const COURSE_ID = "broilerRearing"; // The document ID in Firestore

            // --- DOM ELEMENTS ---
            const elements = {
                loginOverlay: document.getElementById('login-overlay'),
                loginForm: document.getElementById('login-form'),
                loginError: document.getElementById('login-error'),
                adminPanel: document.getElementById('admin-panel'),
                logoutButton: document.getElementById('logout-button'),
                saveAllButton: document.getElementById('save-all-changes'),
                saveStatus: document.getElementById('save-status'),
                // Form inputs
                courseTitle: document.getElementById('course-title'),
                courseSubtitle: document.getElementById('course-subtitle'),
                courseDescription: document.getElementById('course-description'),
                // Module elements
                addModuleForm: document.getElementById('add-module-form'),
                modulesList: document.getElementById('modules-list'),
                // Note elements
                addNoteForm: document.getElementById('add-note-form'),
                addNoteBtn: document.getElementById('add-note-btn'),
                notesList: document.getElementById('notes-list'),
                // Video elements
                addVideoForm: document.getElementById('add-video-form'),
                videosList: document.getElementById('videos-list'),
            };

            // --- LOCAL STATE ---
            let courseData = {};
            let courseDocRef;

            // --- INITIALIZATION & AUTHENTICATION ---
            function init() {
                if (!window.firebase || !window.firebase.auth) {
                    console.error("Firebase not ready, delaying init.");
                    setTimeout(init, 100);
                    return;
                }
                
                courseDocRef = window.firebase.doc(window.firebase.db, "courses", COURSE_ID);

                // Handle Auth State
                window.firebase.onAuthStateChanged(window.firebase.auth, user => {
                    if (user && ADMIN_EMAILS.includes(user.email)) {
                        elements.loginOverlay.style.display = 'none';
                        elements.adminPanel.style.display = 'block';
                        loadCourseData();
                    } else {
                        elements.loginOverlay.style.display = 'flex';
                        elements.adminPanel.style.display = 'none';
                        if (user) { // If user is logged in but not an admin
                            window.firebase.signOut(window.firebase.auth);
                        }
                    }
                });

                // Add Event Listeners
                elements.loginForm.addEventListener('submit', handleLogin);
                elements.logoutButton.addEventListener('click', handleLogout);
                elements.saveAllButton.addEventListener('click', saveAllChanges);
                
                elements.addModuleForm.addEventListener('submit', addModule);
                elements.addNoteForm.addEventListener('submit', addNote);
                elements.addVideoForm.addEventListener('submit', addVideo);

                // Event delegation for delete buttons
                elements.modulesList.addEventListener('click', (e) => handleDeletion(e, 'modules'));
                elements.notesList.addEventListener('click', (e) => handleDeletion(e, 'notes'));
                elements.videosList.addEventListener('click', (e) => handleDeletion(e, 'videos'));
            }

            async function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                elements.loginError.style.display = 'none';

                try {
                    await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    elements.loginError.textContent = "Error: " + error.message;
                    elements.loginError.style.display = 'block';
                }
            }

            function handleLogout() {
                window.firebase.signOut(window.firebase.auth);
            }

            // --- DATA HANDLING ---
            async function loadCourseData() {
                try {
                    const docSnap = await window.firebase.getDoc(courseDocRef);
                    if (docSnap.exists()) {
                        courseData = docSnap.data();
                    } else {
                        // Document doesn't exist, create it with a default structure
                        console.log("No document found. Creating initial document...");
                        courseData = {
                            title: "",
                            subtitle: "",
                            description: "",
                            modules: [],
                            notes: [],
                            videos: []
                        };
                        // Use setDoc to create the document immediately
                        await window.firebase.setDoc(courseDocRef, courseData);
                    }
                    renderAdminPanel();
                } catch (error) {
                    console.error("Error loading course data:", error);
                    showSaveStatus("Error loading data.", "error");
                }
            }

            async function saveAllChanges() {
                showSaveStatus("Saving...", "saving");
                
                // Update local data object from general info fields
                courseData.title = elements.courseTitle.value;
                courseData.subtitle = elements.courseSubtitle.value;
                courseData.description = elements.courseDescription.value;

                try {
                    await window.firebase.setDoc(courseDocRef, courseData);
                    showSaveStatus("Changes saved successfully!", "success");
                } catch (error) {
                    console.error("Error saving data:", error);
                    showSaveStatus("Error saving changes.", "error");
                }
            }

            // --- UI RENDERING ---
            function renderAdminPanel() {
                elements.courseTitle.value = courseData.title || '';
                elements.courseSubtitle.value = courseData.subtitle || '';
                elements.courseDescription.value = courseData.description || '';
                renderList('modules');
                renderList('notes');
                renderList('videos');
            }

            function renderList(type) {
                const listElement = elements[`${type}List`];
                listElement.innerHTML = ''; // Clear current list
                if (!courseData[type]) courseData[type] = [];

                courseData[type].forEach(item => {
                    const card = document.createElement('li');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <div class="item-info">
                            <strong>${item.title}</strong>
                            <span>${item.description || item.url}</span>
                        </div>
                        <button class="btn-delete" data-id="${item.id}" data-type="${type}">Delete</button>
                    `;
                    listElement.appendChild(card);
                });
            }

            // --- ITEM MANAGEMENT (ADD/DELETE) ---
            function addModule(e) {
                e.preventDefault();
                const titleInput = document.getElementById('module-title');
                const descInput = document.getElementById('module-description');
                
                const newModule = {
                    id: Date.now().toString(), // Simple unique ID
                    title: titleInput.value,
                    description: descInput.value
                };
                courseData.modules.push(newModule);
                renderList('modules');
                e.target.reset();
            }

            async function addNote(e) {
                e.preventDefault();
                const titleInput = document.getElementById('note-title');
                const fileInput = document.getElementById('note-file');
                const file = fileInput.files[0];
                if (!file) return;

                elements.addNoteBtn.disabled = true;
                elements.addNoteBtn.textContent = "Uploading...";

                const filePath = `notes/${COURSE_ID}/${Date.now()}_${file.name}`;
                const storageRef = window.firebase.ref(window.firebase.storage, filePath);
                
                try {
                    // Upload file
                    const snapshot = await window.firebase.uploadBytes(storageRef, file);
                    // Get download URL
                    const downloadURL = await window.firebase.getDownloadURL(snapshot.ref);

                    const newNote = {
                        id: Date.now().toString(),
                        title: titleInput.value,
                        url: downloadURL,
                        filePath: filePath // Store path for deletion
                    };
                    courseData.notes.push(newNote);
                    renderList('notes');
                    e.target.reset();
                } catch (error) {
                    console.error("Error uploading file: ", error);
                    alert("File upload failed. Please try again.");
                } finally {
                    elements.addNoteBtn.disabled = false;
                    elements.addNoteBtn.textContent = "+ Upload & Add Note";
                }
            }
            
            function addVideo(e) {
                e.preventDefault();
                const titleInput = document.getElementById('video-title');
                const urlInput = document.getElementById('video-url');
                
                const newVideo = {
                    id: Date.now().toString(),
                    title: titleInput.value,
                    url: urlInput.value
                };
                courseData.videos.push(newVideo);
                renderList('videos');
                e.target.reset();
            }

            async function handleDeletion(event, listType) {
                const target = event.target;
                if (!target.matches('.btn-delete')) return;

                const idToDelete = target.dataset.id;
                if (!confirm("Are you sure you want to delete this item?")) return;

                // For notes, delete the file from storage first
                if (listType === 'notes') {
                    const noteToDelete = courseData.notes.find(n => n.id === idToDelete);
                    if (noteToDelete && noteToDelete.filePath) {
                        try {
                            const fileRef = window.firebase.ref(window.firebase.storage, noteToDelete.filePath);
                            await window.firebase.deleteObject(fileRef);
                            console.log("File deleted from storage.");
                        } catch (error) {
                           console.error("Error deleting file from storage:", error);
                           // Decide if you want to stop the process or just log the error
                           if (error.code !== 'storage/object-not-found') {
                               alert("Could not delete the associated file from storage. Please check the console.");
                               return; // Stop if deletion fails for reasons other than "not found"
                           }
                        }
                    }
                }

                // Update local data by filtering out the deleted item
                courseData[listType] = courseData[listType].filter(item => item.id !== idToDelete);
                
                // Re-render the updated list
                renderList(listType);
            }


            // --- UTILITY ---
            function showSaveStatus(message, status) { // status can be 'saving', 'success', or 'error'
                elements.saveStatus.textContent = message;
                elements.saveStatus.className = status; // Reset classes and add the new one
                if (status === 'success' || status === 'error') {
                    setTimeout(() => {
                        elements.saveStatus.className = '';
                    }, 3000);
                }
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>
