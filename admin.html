<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | AlfaOctal Campus Content Management</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase SDK Integration -->
    <script>
        // Secure Firebase configuration using placeholders
        const firebaseConfig = {
            apiKey: "%%FIREBASE_API_KEY%%",
            authDomain: "%%FIREBASE_AUTH_DOMAIN%%",
            databaseURL: "https://mordern-farm-default-rtdb.firebaseio.com",
            projectId: "%%FIREBASE_PROJECT_ID%%",
            storageBucket: "%%FIREBASE_STORAGE_BUCKET%%",
            messagingSenderId: "%%FIREBASE_MESSAGING_SENDER_ID%%",
            appId: "%%FIREBASE_APP_ID%%",
            measurementId: "%%FIREBASE_MEASUREMENT_ID%%"
        };
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        try {
            const app = initializeApp(firebaseConfig);
            window.firebase = {
                app,
                auth: getAuth(app),
                db: getFirestore(app),
                storage: getStorage(app),
                onAuthStateChanged, signInWithEmailAndPassword, signOut,
                doc, getDoc, setDoc,
                ref, uploadBytes, getDownloadURL, deleteObject
            };
            console.log("Firebase Initialized for Admin Panel.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    </script>

    <style>
        :root {
            --color-primary: #e53935;
            --color-success: #43a047;
            --bg-dark: #121212;
            --bg-light: #1e1e1e;
            --bg-card: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --border-color: #424242;
            --border-radius: 8px;
            --font-primary: 'Inter', sans-serif;
            --transition: all 0.3s ease;
            --sidebar-width: 260px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-size: 16px;
        }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px); z-index: 1000; display: flex;
            align-items: center; justify-content: center;
        }
        #login-container {
            width: 100%; max-width: 400px; padding: 2rem; background: var(--bg-light);
            border: 1px solid var(--border-color); border-radius: var(--border-radius);
            text-align: center;
        }
        #login-container h1 { margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-input {
            width: 100%; padding: 0.8rem; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-primary); font-size: 1rem;
        }
        .form-input:focus { border-color: var(--color-primary); outline: none; }
        .btn {
            width: 100%; padding: 0.8rem; border: none; border-radius: 4px;
            font-weight: 600; font-size: 1rem; cursor: pointer; transition: var(--transition);
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #c62828; }
        .error-text { color: var(--color-primary); margin-top: 1rem; font-weight: 500; }
        
        /* --- Admin Panel Layout --- */
        #admin-panel { display: none; height: 100vh; display: flex; }
        
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-light);
            padding: 1.5rem 1rem; border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out; display: flex; flex-direction: column;
        }
        .sidebar-header { text-align: center; margin-bottom: 2rem; }
        .sidebar-header img { max-width: 150px; }

        .sidebar-nav { list-style: none; }
        .sidebar-nav a {
            display: flex; align-items: center; padding: 0.9rem;
            color: var(--text-secondary); text-decoration: none; border-radius: 6px;
            margin-bottom: 0.5rem; transition: var(--transition);
        }
        .sidebar-nav a:hover { background-color: var(--bg-card); color: var(--text-primary); }
        .sidebar-nav a.active { background-color: var(--color-primary); color: white; }
        .sidebar-nav i { width: 30px; font-size: 1rem; text-align: center; }
        .sidebar-nav span { font-weight: 500; }

        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 2rem; background: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 10;
        }
        .main-header h1 { font-size: 1.5rem; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .btn-logout, .btn-save {
            padding: 0.6rem 1.2rem; border-radius: 4px; font-weight: 600;
            cursor: pointer; transition: var(--transition); width: auto;
        }
        .btn-logout { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-logout:hover { border-color: var(--color-primary); color: var(--color-primary); }
        
        #mobile-menu-btn { display: none; }

        .content-wrapper { padding: 2rem; }
        .content-section {
            background: var(--bg-card); padding: 1.5rem;
            border-radius: var(--border-radius); margin-bottom: 2rem;
        }
        .content-section h2 { margin-bottom: 1.5rem; font-size: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        textarea.form-input { min-height: 120px; resize: vertical; }

        /* --- New Notes Section --- */
        .note-card {
            background: var(--bg-light); border: 1px solid var(--border-color);
            border-radius: 6px; margin-bottom: 1rem; overflow: hidden;
        }
        .note-card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; cursor: pointer; user-select: none;
        }
        .note-card-header:hover { background-color: #3c3c3c; }
        .note-card-header h3 { font-size: 1.1rem; flex-grow: 1; }
        .note-card-actions { display: flex; align-items: center; gap: 0.5rem; }
        .note-card-actions .toggle-icon { transition: transform 0.3s ease; }
        .note-card-actions button {
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 1.1rem; padding: 0.3rem;
        }
        .note-card-actions button:hover { color: var(--color-primary); }
        .note-card-body {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }
        .note-card-body .form-group { padding: 0 1rem; }
        .note-card.is-open .note-card-body {
            max-height: 1000px; /* Large value to allow content to expand */
            padding-bottom: 1rem;
        }
        .note-card.is-open .toggle-icon { transform: rotate(180deg); }

        /* Item lists (for videos) */
        .item-list { list-style: none; margin-top: 1.5rem; }
        .item-card {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-light); padding: 1rem; border-radius: 4px;
            margin-bottom: 0.5rem; border: 1px solid var(--border-color);
        }
        .item-info { flex-grow: 1; overflow: hidden; }
        .item-info strong { display: block; color: var(--text-primary); }
        .item-info span { font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-delete {
            background: #424242; color: var(--text-primary); padding: 0.5rem 0.8rem;
            border: none; border-radius: 4px; font-weight: 600; cursor: pointer; flex-shrink: 0;
        }
        .btn-delete:hover { background: var(--color-primary); }

        #save-status {
            position: fixed; bottom: 20px; right: 20px; z-index: 500;
            padding: 1rem 1.5rem; border-radius: var(--border-radius);
            font-weight: 600; color: white; transition: var(--transition);
            transform: translateY(200%); opacity: 0;
        }
        #save-status.saving { background-color: #ffc107; color: black; transform: translateY(0); opacity: 1; }
        #save-status.success { background-color: var(--color-success); transform: translateY(0); opacity: 1; }
        #save-status.error { background-color: var(--color-primary); transform: translateY(0); opacity: 1; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; height: 100%; z-index: 200;
                transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.is-open { transform: translateX(0); }
            .main-header h1 { font-size: 1.2rem; }
            #mobile-menu-btn {
                display: block; background: none; border: none; color: var(--text-primary);
                font-size: 1.5rem; cursor: pointer; margin-right: 1rem;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div id="login-container">
            <h1>Admin Login</h1>
            <form id="login-form">
                <div class="form-group">
                    <input type="email" id="login-email" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="login-error" class="error-text" style="display: none;"></p>
            </form>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="images/logo.png" alt="Logo">
            </div>
            <ul class="sidebar-nav" id="sidebar-nav">
                 <li><a href="#" class="active" data-page="broiler-course-page"><i class="fa-solid fa-drumstick-bite"></i> <span>Broiler Rearing</span></a></li>
                 <li><a href="#" data-page="roadrunner-course-page"><i class="fa-solid fa-feather-pointed"></i> <span>Roadrunner Rearing</span></a></li>
                 <li><a href="#" data-page="mushroom-course-page"><i class="fa-solid fa-staff-aesculapius"></i> <span>Mushroom Cultivation</span></a></li>
                 <li><a href="#" data-page="fish-course-page"><i class="fa-solid fa-fish-fins"></i> <span>Fish Farming</span></a></li>
                 <li><a href="#" data-page="maize-course-page"><i class="fa-solid fa-seedling"></i> <span>Maize Farming</span></a></li>
                 <li><a href="#" data-page="sorghum-course-page"><i class="fa-solid fa-wheat-awn"></i> <span>Sorghum Farming</span></a></li>
                 <li><a href="#" data-page="tobacco-course-page"><i class="fa-solid fa-smoking"></i> <span>Tobacco Farming</span></a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div style="display: flex; align-items: center;">
                    <button id="mobile-menu-btn"><i class="fa-solid fa-bars"></i></button>
                    <h1 id="main-content-title">Edit: Broiler Rearing</h1>
                </div>
                <div class="header-actions">
                     <button id="save-all-changes" class="btn btn-primary btn-save">Save All Changes</button>
                     <button id="logout-button" class="btn-logout">Logout</button>
                </div>
            </header>
            
            <div class="content-wrapper">
                <!-- Section 1: General Information -->
                <section class="content-section">
                    <h2>General Information</h2>
                    <div class="form-group">
                        <label for="course-title" class="form-label">Course Title</label>
                        <input type="text" id="course-title" class="form-input" placeholder="e.g., Ultimate Broiler Rearing Masterclass">
                    </div>
                    <div class="form-group">
                        <label for="course-subtitle" class="form-label">Course Subtitle</label>
                        <input type="text" id="course-subtitle" class="form-input" placeholder="e.g., From Chick to Profit in 7 Weeks">
                    </div>
                    <div class="form-group">
                        <label for="course-description" class="form-label">Course Description</label>
                        <textarea id="course-description" class="form-input" placeholder="Detailed description of the course. You can use <br> for line breaks."></textarea>
                    </div>
                </section>

                <!-- Section 2: Course Notes -->
                <section class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                         <h2>Course Notes</h2>
                         <button id="add-note-card-btn" class="btn btn-primary" style="width: auto; padding: 0.6rem 1rem;">+ Add Note Section</button>
                    </div>
                    <div id="notes-container">
                        <!-- Note cards will be dynamically added here -->
                    </div>
                </section>

                <!-- Section 3: Video Gallery -->
                <section class="content-section">
                    <h2>Video Gallery</h2>
                    <form id="add-video-form">
                        <div class="form-group">
                            <input type="text" id="video-title" class="form-input" placeholder="Video Title" required>
                        </div>
                        <div class="form-group">
                            <input type="url" id="video-url" class="form-input" placeholder="Full YouTube URL (e.g., https://www.youtube.com/watch?v=...)" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: auto;">+ Add Video</button>
                    </form>
                     <ul id="videos-list" class="item-list">
                        <!-- Videos will be dynamically listed here -->
                    </ul>
                </section>
            </div>
        </main>
    </div>
    
    <div id="save-status"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const ADMIN_EMAILS = ["admin@alfaoctal.com", "admin2@alfaoctal.com"];
        const PAGES = {
            'broiler-course-page': { id: 'broilerRearing', title: 'Broiler Rearing'},
            'roadrunner-course-page': { id: 'roadrunnerRearing', title: 'Roadrunner Rearing'},
            'mushroom-course-page': { id: 'mushroomCultivation', title: 'Mushroom Cultivation'},
            'fish-course-page': { id: 'fishFarming', title: 'Fish Farming'},
            'maize-course-page': { id: 'maizeFarming', title: 'Maize Farming'},
            'sorghum-course-page': { id: 'sorghumFarming', title: 'Sorghum Farming'},
            'tobacco-course-page': { id: 'tobaccoFarming', title: 'Tobacco Farming'}
        };

        // --- DOM ELEMENTS ---
        const elements = {
            loginOverlay: document.getElementById('login-overlay'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            adminPanel: document.getElementById('admin-panel'),
            logoutButton: document.getElementById('logout-button'),
            saveAllButton: document.getElementById('save-all-changes'),
            saveStatus: document.getElementById('save-status'),
            sidebar: document.getElementById('sidebar'),
            sidebarNav: document.getElementById('sidebar-nav'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            mainContentTitle: document.getElementById('main-content-title'),
            courseTitle: document.getElementById('course-title'),
            courseSubtitle: document.getElementById('course-subtitle'),
            courseDescription: document.getElementById('course-description'),
            notesContainer: document.getElementById('notes-container'),
            addNoteCardBtn: document.getElementById('add-note-card-btn'),
            addVideoForm: document.getElementById('add-video-form'),
            videosList: document.getElementById('videos-list'),
        };

        // --- LOCAL STATE ---
        let courseData = {};
        let currentCourseId = 'broilerRearing'; // Default
        let courseDocRef;

        // --- INITIALIZATION & AUTHENTICATION ---
        function init() {
            if (!window.firebase || !window.firebase.auth) {
                setTimeout(init, 100);
                return;
            }

            window.firebase.onAuthStateChanged(window.firebase.auth, user => {
                if (user && ADMIN_EMAILS.includes(user.email)) {
                    elements.loginOverlay.style.display = 'none';
                    elements.adminPanel.style.display = 'flex';
                    switchCourse(PAGES['broiler-course-page'].id, PAGES['broiler-course-page'].title);
                } else {
                    elements.loginOverlay.style.display = 'flex';
                    elements.adminPanel.style.display = 'none';
                    if (user) window.firebase.signOut(window.firebase.auth);
                }
            });

            addEventListeners();
        }

        function addEventListeners() {
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.logoutButton.addEventListener('click', handleLogout);
            elements.saveAllButton.addEventListener('click', saveAllChanges);
            elements.sidebarNav.addEventListener('click', handleNavClick);
            elements.mobileMenuBtn.addEventListener('click', () => elements.sidebar.classList.toggle('is-open'));
            elements.addNoteCardBtn.addEventListener('click', () => createNoteCard());
            elements.notesContainer.addEventListener('click', handleNoteCardActions);
            elements.addVideoForm.addEventListener('submit', addVideo);
            elements.videosList.addEventListener('click', e => handleDeletion(e, 'videos'));
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            elements.loginError.style.display = 'none';
            try {
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
            } catch (error) {
                elements.loginError.textContent = "Error: " + error.message;
                elements.loginError.style.display = 'block';
            }
        }

        function handleLogout() { window.firebase.signOut(window.firebase.auth); }

        function handleNavClick(e) {
            e.preventDefault();
            const link = e.target.closest('a');
            if (!link) return;
            
            document.querySelector('.sidebar-nav a.active').classList.remove('active');
            link.classList.add('active');
            
            const pageKey = link.dataset.page;
            const pageInfo = PAGES[pageKey];
            switchCourse(pageInfo.id, pageInfo.title);
            
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.remove('is-open');
            }
        }
        
        // --- PAGE & DATA MANAGEMENT ---
        function switchCourse(courseId, courseTitle) {
            currentCourseId = courseId;
            elements.mainContentTitle.textContent = `Edit: ${courseTitle}`;
            courseDocRef = window.firebase.doc(window.firebase.db, "courses", currentCourseId);
            loadCourseData();
        }

        async function loadCourseData() {
            try {
                const docSnap = await window.firebase.getDoc(courseDocRef);
                if (docSnap.exists()) {
                    courseData = docSnap.data();
                } else {
                    console.log("No document found for this course. Creating an initial document...");
                    courseData = { title: "", subtitle: "", description: "", notes: [], videos: [] };
                    await window.firebase.setDoc(courseDocRef, courseData);
                }
                renderAdminPanel();
            } catch (error) {
                console.error("Error loading course data:", error);
                showSaveStatus("Error loading data.", "error");
            }
        }

        async function saveAllChanges() {
            showSaveStatus("Saving...", "saving");
            
            // Create a fresh data object from the DOM to ensure consistency
            const dataToSave = {
                title: elements.courseTitle.value,
                subtitle: elements.courseSubtitle.value,
                description: elements.courseDescription.value,
                notes: [],
                videos: courseData.videos || [] // Start with the videos from the current state
            };
            
            const noteCards = elements.notesContainer.querySelectorAll('.note-card');
            noteCards.forEach(card => {
                const title = card.querySelector('.note-title-input').value;
                const content = card.querySelector('.note-content-textarea').value;
                if (title || content) { // Only save if there's some content
                    dataToSave.notes.push({ title, content });
                }
            });

            try {
                // Save the complete, updated object to Firestore
                await window.firebase.setDoc(courseDocRef, dataToSave);
                // Update the local state to match what was just saved
                courseData = dataToSave;
                showSaveStatus("Changes saved successfully!", "success");
            } catch (error) {
                console.error("Error saving data:", error);
                showSaveStatus("Error saving changes.", "error");
            }
        }

        // --- UI RENDERING ---
        function renderAdminPanel() {
            elements.courseTitle.value = courseData.title || '';
            elements.courseSubtitle.value = courseData.subtitle || '';
            elements.courseDescription.value = courseData.description || '';
            renderNotes();
            renderList('videos');
        }

        // --- NOTES MANAGEMENT ---
        function renderNotes() {
            elements.notesContainer.innerHTML = '';
            if (!courseData.notes) courseData.notes = [];
            courseData.notes.forEach(note => createNoteCard(note.title, note.content));
        }
        
        function createNoteCard(title = '', content = '') {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.innerHTML = `
                <div class="note-card-header">
                    <h3><input type="text" class="form-input note-title-input" placeholder="Note Section Title" value="${title}"></h3>
                    <div class="note-card-actions">
                        <button class="btn-delete-note" title="Delete Note"><i class="fa-solid fa-trash"></i></button>
                        <i class="fa-solid fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div class="note-card-body">
                    <div class="form-group">
                        <textarea class="form-input note-content-textarea" placeholder="Write your notes here... You can use HTML tags like <br> for line breaks.">${content}</textarea>
                    </div>
                </div>
            `;
            elements.notesContainer.appendChild(card);
        }
        
        function handleNoteCardActions(e) {
            const header = e.target.closest('.note-card-header');
            const deleteBtn = e.target.closest('.btn-delete-note');
            
            if (deleteBtn) {
                if (confirm('Are you sure you want to delete this note section?')) {
                    deleteBtn.closest('.note-card').remove();
                }
                return;
            }

            if (header) {
                header.parentElement.classList.toggle('is-open');
            }
        }

        // --- VIDEO & GENERIC LIST MANAGEMENT ---
        function addVideo(e) {
            e.preventDefault();
            const titleInput = document.getElementById('video-title');
            const urlInput = document.getElementById('video-url');
            if (!courseData.videos) courseData.videos = [];

            const newVideo = {
                id: Date.now().toString(),
                title: titleInput.value,
                url: urlInput.value
            };
            courseData.videos.push(newVideo);
            renderList('videos');
            e.target.reset();
        }

        function renderList(type) {
            const listElement = elements[`${type}List`];
            if (!listElement) return;
            listElement.innerHTML = ''; 
            if (!courseData[type]) courseData[type] = [];

            courseData[type].forEach(item => {
                const card = document.createElement('li');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-info">
                        <strong>${item.title}</strong>
                        <span>${item.description || item.url}</span>
                    </div>
                    <button class="btn-delete" data-id="${item.id}" data-type="${type}">Delete</button>
                `;
                listElement.appendChild(card);
            });
        }
        
        function handleDeletion(event) {
            const target = event.target.closest('.btn-delete');
            if (!target) return;

            const listType = target.dataset.type;
            const idToDelete = target.dataset.id;
            
            if (confirm("Are you sure you want to delete this item?")) {
                courseData[listType] = courseData[listType].filter(item => item.id !== idToDelete);
                renderList(listType);
            }
        }

        // --- UTILITY ---
        function showSaveStatus(message, status) { 
            elements.saveStatus.textContent = message;
            elements.saveStatus.className = status;
            if (status === 'success' || status === 'error') {
                setTimeout(() => { elements.saveStatus.className = ''; }, 3000);
            }
        }

        init();
    });
    </script>
</body>
</html>
